#!/bin/bash
#set -exu

# scan recent user directory (/home/username/public_html) using ClamAV & LMD (Maldet) and report via e-mail if malware found

adminmail=mail@here
cpath=/usr/local/bin/clamscan
mpath=/usr/local/sbin/maldet
clog=/var/log/maldetcron.log
mlog=/var/log/clamscancron.log
lowprioprefix="/bin/nice -n 19 /usr/bin/ionice -c2 -n7"
donotreport=" OK| Empty file|php.malware.fopo.538|thisfileisok|thispathisokdonotreport|anotherstringinpath"

# Clamscan
$lowprioprefix $cpath /var/tmp /tmp /dev/shm /home/"$(ls -lt /home|head -n 3|tail -n 1|grep -v root|awk '{print $4}')"/public_html >> "$clog" 2>/dev/null
#if [[ "$(cat "$clog")" != *"Infected files: 0"* ]];then cat -v "$clog"|grep -Ev "$donotreport"|tr -d \\r|mail -s "$(hostname) ClamScan cron" $adminmail;fi
rm -f "$clog"

# Maldet
$lowprioprefix $mpath -d -u -a /home/"$(ls -lt /home|head -n 3|tail -n 1|grep -v root|awk '{print $4}')"/public_html >> "$mlog" 2>/dev/null
grep "$(date +"%b %d %H")" /usr/local/maldetect/logs/event_log|grep -Ev "{mon}|{scan}|{update}|{alert}|{glob}|error handling" >> "$mlog"
if [[ "$(cat "$mlog")" != *"malware hits 0"* ]];then exit;fi
if [[ "$(grep -cEi "\"$donotreport\"" "$mlog")" != "0" ]];then exit;fi
cat -v "$mlog"|grep -Ev "$donotreport"|tr -d \\r|mail -s "$(hostname) Maldet cron" $adminmail;fi
rm -f "$mlog"
